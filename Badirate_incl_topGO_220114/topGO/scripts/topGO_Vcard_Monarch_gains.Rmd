---
title: "topGO_Vanessa_cardui_and Danaus plexipphus gains"
author: "KN"
date: "01/19/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Gene ontology enrichment test for genes gained in Vanessa cardui and Monarch

Input
1. gene-universe: all genes annotated in Vanessa cardui
2. genes of interest: the output of BadiRate, genes belonging to gene families with different growth rate in Vanessa cardui and D. plexippus compared the others (branch specific model higher fit then global model), specifically gene families with gene gains >0 in both branches. The gene gains have been parsed with separate scripts get_best_model_gains.sh, manually selected the orthogroups with gains >0 in both branches and the the gene names in the orthogroups are retrieved with gene_selector_mod.sh

```{r setup2, include=FALSE}
library(topGO)
library(ggplot2)
```

```{r data}

#create an object with all gene identifiers and corresponding GO-terms
#readMappings(file, sep = "\t", IDsep = ",")
geneID2GO <- readMappings(file="../TopGO_Data_Prep/Vanessa_TopGo_reference_base_filtered.tsv", sep = "\t", IDsep = ",")
str(head(geneID2GO))

#gene universe, vector of gene names
geneNames <- names(geneID2GO)
head(geneNames)

#read the list of genes of interest
candidate_genes <- read.table("../../results/spM_gains_bestmodel_both.txt_genenames.txt", header = F)
colnames(candidate_genes) <- "geneid"
head(candidate_genes)

candidate_genes <- as.character(candidate_genes$geneid)
geneList <- factor(as.integer(geneNames %in% candidate_genes))
names(geneList) <- geneNames
head(geneList)
str(geneList)

#create the topGOdata object for each ontology
GO_data_BP <- new("topGOdata", 
               ontology="BP", 
               allGenes=geneList, 
               annot=annFUN.gene2GO, 
               gene2GO=geneID2GO, 
               nodeSize=1)
GO_data_BP

GO_data_CC <- new("topGOdata", 
               ontology="CC", 
               allGenes=geneList, 
               annot=annFUN.gene2GO, 
               gene2GO=geneID2GO, 
               nodeSize=1)
GO_data_CC

GO_data_MF <- new("topGOdata", 
               ontology="MF", 
               allGenes=geneList, 
               annot=annFUN.gene2GO, 
               gene2GO=geneID2GO, 
               nodeSize=1)
GO_data_MF





```



```{r test}
#"when only a list of interesting genes is provided, 
#the user can use only tests statistics that are based on gene counts, 
#like Fisherâ€™s exact test, Z score and alike."

#biological process
BP_resultFisher_weight01 <- runTest(GO_data_BP, algorithm = "weight01", statistic = "fisher")
BP_resultFisher_weight01

BP_resultFisher_classic <- runTest(GO_data_BP, algorithm = "classic", statistic = "fisher")
BP_resultFisher_classic



#allGO = usedGO(object = GOdata)
#topNodes = length(allGO) in GenTable() to get a table with all GO:s to do fdr
allGO = usedGO(object = GO_data_BP)
allRes_BP <- GenTable(GO_data_BP, 
                   weight01Fisher = BP_resultFisher_weight01, 
                   classicFisher = BP_resultFisher_classic,
                   orderBy = "weight01Fisher", 
                   ranksOf = "weight01Fisher", 
                   topNodes = length(allGO),
                   numChar=1000)

allRes_BP$weight01Fisher <- as.numeric(allRes_BP$weight01Fisher)
allRes_BP[allRes_BP$weight01Fisher<=0.05, ]

#multiple test correction, method Benjamini-Hochberg
allRes_BP$p_adj <- p.adjust(allRes_BP$weight01Fisher, method = "fdr")
#adj p-value above 0.05
allRes_BP[allRes_BP$p_adj<=0.05, ]
allRes_BP$GO_class <- "BP"




#cellular compartment
CC_resultFisher_weight01 <- runTest(GO_data_CC, algorithm = "weight01", statistic = "fisher")
CC_resultFisher_weight01

CC_resultFisher_classic <- runTest(GO_data_CC, algorithm = "classic", statistic = "fisher")
CC_resultFisher_classic

allGO = usedGO(object = GO_data_CC)
allRes_CC <- GenTable(GO_data_CC, 
                   weight01Fisher = CC_resultFisher_weight01,
                   classicFisher = CC_resultFisher_classic,
                   orderBy = "weight01Fisher", 
                   ranksOf = "weight01Fisher", 
                   topNodes = length(allGO),
                   numChar=1000)

allRes_CC$weight01Fisher <- as.numeric(allRes_CC$weight01Fisher)
allRes_CC[allRes_CC$weight01Fisher<=0.05, ]
allRes_CC$p_adj <- p.adjust(allRes_CC$weight01Fisher, method = "fdr")
allRes_CC[allRes_CC$p_adj<=0.05, ]
allRes_CC$GO_class <- "CC"

#molecular function
MF_resultFisher_weight01 <- runTest(GO_data_MF, algorithm = "weight01", statistic = "fisher")
MF_resultFisher_weight01

MF_resultFisher_classic <- runTest(GO_data_MF, algorithm = "classic", statistic = "fisher")
MF_resultFisher_classic

#only top 20
allGO = usedGO(object = GO_data_MF)
allRes_MF <- GenTable(GO_data_MF, 
                   weight01Fisher = MF_resultFisher_weight01,
                   classicFisher = MF_resultFisher_classic,
                   orderBy = "weight01Fisher", 
                   ranksOf = "weight01Fisher", 
                   topNodes = length(allGO),
                   numChar=1000)

allRes_MF$weight01Fisher <- as.numeric(allRes_MF$weight01Fisher)
allRes_MF[allRes_MF$weight01Fisher<=0.05, ]
allRes_MF$p_adj <- p.adjust(allRes_MF$weight01Fisher, method = "fdr")
allRes_MF[allRes_MF$p_adj<=0.05, ]
allRes_MF$GO_class <- "MF"

# sel.terms <- allRes_MF[allRes_MF$weight01Fisher<=0.05, 1]
# ann.genes <- genesInTerm(GO_data_MF, sel.terms)
# intersect(ann.genes, candidate_genes)

sg_BP <- sigGenes(GO_data_BP)
write(sg_BP, "../result_topGO/interesting_genes")

sel.terms_BP <- allRes_BP[allRes_BP$p_adj<=0.05, 1]
ann.genes_BP <- genesInTerm(GO_data_BP, sel.terms_BP) #gives all genes with these go

sel.terms_MF <- allRes_MF[allRes_MF$p_adj<=0.05, 1]
ann.genes_MF <- genesInTerm(GO_data_MF, sel.terms_MF) #gives all genes with these go

#add sign genes per GO
allRes_BP$genes <- sapply(allRes_BP$GO.ID,
                          function(x)
                            {
                            genes_sel <- genesInTerm(GO_data_BP, x)
                            genes_sel[[1]][genes_sel[[1]] %in% candidate_genes]
                            })
allRes_BP$genes <- vapply(allRes_BP$genes, paste, collapse =",", character(1L))

allRes_CC$genes <- sapply(allRes_CC$GO.ID,
                          function(x)
                            {
                            genes_sel <- genesInTerm(GO_data_CC, x)
                            genes_sel[[1]][genes_sel[[1]] %in% candidate_genes]
                            })

allRes_CC$genes <- vapply(allRes_CC$genes, paste, collapse =",", character(1L))

allRes_MF$genes <- sapply(allRes_MF$GO.ID,
                          function(x)
                            {
                            genes_sel <- genesInTerm(GO_data_MF, x)
                            genes_sel[[1]][genes_sel[[1]] %in% candidate_genes]
                            })

allRes_MF$genes <- vapply(allRes_MF$genes, paste, collapse =",", character(1L))


```

```{r write results, echo=F, eval=F}
write.table(allRes_BP[1:50,], file = "../result_topGO/V_cardui_D_plex_gains_res_topGO_VC_DP_BP_50.txt")
write.table(allRes_CC[1:50,], file = "../result_topGO/V_cardui_D_plex_gains_res_topGO_VC_DP_CC_50.txt")
write.table(allRes_MF[1:50,], file = "../result_topGO/V_cardui_D_plex_gains_res_topGO_VC_DP_MF_50.txt")

write.table(rbind(allRes_BP[allRes_BP$p_adj<=0.05, ], allRes_CC[allRes_CC$p_adj<=0.05, ], allRes_MF[allRes_MF$p_adj<=0.05, ]), file = "../result_topGO/V_cardui_D_plex_gains_res_topGO_VC_DP_sign.txt",row.names = FALSE)

#semicolon sep, without quotes
write.table(rbind(allRes_BP[allRes_BP$p_adj<=0.05, ], allRes_CC[allRes_CC$p_adj<=0.05, ], allRes_MF[allRes_MF$p_adj<=0.05, ]), file = "../result_topGO/V_cardui_res_topGO_VC_DP_sign.csv", row.names = FALSE, sep = ";", quote = FALSE)



```


```{r plots_weight}

allRes_all_comb <- rbind(allRes_BP[allRes_BP$weight01Fisher<=0.01, ], allRes_CC[allRes_CC$weight01Fisher<=0.01, ], allRes_MF[allRes_MF$weight01Fisher<=0.01, ])

allRes_all_comb$GO_descr <- paste(allRes_all_comb$Term," (",allRes_all_comb$GO.ID,")", sep = "")

#plot go-terma and number of significant genes
ggplot(allRes_all_comb, aes(reorder(GO_descr, -Significant), Significant)) +
    geom_bar(stat = "identity", aes(fill=GO_class)) +
  facet_grid(~GO_class, scales = "free_x", space = "free_x") +
  ylab("Number of genes") +
  scale_fill_discrete(guide = guide_legend(label.position = "top")) +
  theme(panel.background = element_blank(),
        strip.background = element_blank(),
        strip.text = element_blank(),
        axis.line = element_line(size = 0.2, colour = "grey"),
        axis.text.x = element_text(size = 12, angle = 90, vjust = 0.5, hjust = 1),
        axis.text.y = element_text(size = 12, angle = 90, hjust = 0.5),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 12, angle = 90),
        legend.title = element_blank(),
        legend.text = element_text(size = 12, angle = 90, vjust = 0.5),
        legend.position = "top"
        )




```

```{r plots_p.adj}

  allRes_all_adj <- rbind(allRes_BP[allRes_BP$p_adj<=0.05, ], allRes_CC[allRes_CC$p_adj<=0.05, ], allRes_MF[allRes_MF$p_adj<=0.05, ])

allRes_all_adj$GO_descr <- paste(allRes_all_adj$Term," (",allRes_all_adj$GO.ID,")", sep = "")

#plot go-terma and number of significant genes
plot_topGO_VM <- ggplot(allRes_all_adj, aes(reorder(GO_descr, -Significant), Significant)) +
    geom_bar(stat = "identity", aes(fill=GO_class)) +
  facet_grid(~GO_class, scales = "free_x", space = "free_x") +
  ylab("Number of genes") +
  scale_fill_discrete(type=c("#d19200","#4d3500", "#916400"),guide = guide_legend(label.position = "top")) +
  theme(panel.background = element_blank(),
        strip.background = element_blank(),
        strip.text = element_blank(),
        axis.line = element_line(size = 0.2, colour = "grey"),
        axis.ticks = element_line(size = 0.2, colour = "grey"),
        axis.text.x = element_text(size = 10, angle = 90, vjust = 0.5, hjust = 1),
        axis.text.y = element_text(size = 10, angle = 90, hjust = 0.5),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 10, angle = 90),
        legend.title = element_blank(),
        legend.text = element_text(size = 10, angle = 90, vjust = 0.5),
        legend.position = c(0.5,0.8),
        legend.direction = "horizontal"
        )


plot_topGo <- ggplot(allRes_all_fdr, aes(reorder(GO_descr, -Significant), Significant)) +
    geom_bar(stat = "identity", aes(fill=GO_class)) +
  facet_grid(~GO_class, scales = "free_x", space = "free_x") +
  ylab("Number of genes") +
  scale_fill_discrete(type=c("#d19200","#4d3500", "#916400"),guide = guide_legend(label.position = "top")) +
  theme(panel.background = element_blank(),
        strip.background = element_blank(),
        strip.text = element_blank(),
        axis.line = element_line(size = 0.2, colour = "grey"),
        axis.ticks = element_line(size = 0.2, colour = "grey"),
        axis.text.x = element_text(size = 10, angle = 90, vjust = 0.5, hjust = 1),
        axis.text.y = element_text(size = 10, angle = 90, hjust = 0.5),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 10, angle = 90),
        legend.title = element_blank(),
        legend.text = element_text(size = 10, angle = 90, vjust = 0.5),
        legend.position = c(0.5,0.8),
        legend.direction = "horizontal"
        )


ggsave(plot = plot_topGO_VM, "../result_topGO/V_and_M_barplot_brown.pdf")




```