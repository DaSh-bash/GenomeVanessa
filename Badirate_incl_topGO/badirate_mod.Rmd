---
title: "badirater_mod"
author: "KN"
date: '2021-06-09'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## BadiRate 
This is how we run BadiRate, some steps uses BadirateR (https://github.com/palfalvi/badirater).
The scripts explain the process modifying the input (output of Orthofinder). The output is one file per replicate and orthogroup, with all the output from BadiRate. The result have to be parsed, this script includes how to get a list of orthogroups with higher model fit for the specific branch model compared to null model. Separate script parses the gains and losses from the result files. 

Input: Output from OrthoFinder modified Orthogroups.GeneCount.tsv

```{bash}
#remove field total 
cut -f -10 Orthogroups.GeneCount.tsv | awk '{print NF}' |uniq -c
#15297 10
cut -f -10 Orthogroups.GeneCount.tsv > Orthogroups.GeneCount_mod.tsv 

```

Input: Ultrametric tree, convert species tree from OrthoFinder to ultrametric using ete3

```{python}
#create ultra metric tree
#to use 
conda activate ete3
#python
python

#convert tree to ultra metric
#https://www.biostars.org/p/251282/

from ete3 import Tree
t = Tree("(Danaus_plexippus:0.0958765,(((Maniola_hyperantus:0.0764047,Pararge_aegeria:0.0713074)0.0306248,Bicyclus_anynana:0.136947)0.0652443,((Junonia_coenia:0.196176,(Vanessa_cardui:0.117618,Vanessa_tameamea:0.0427329)0.0619958)0.0459092,(Heliconius_melpomene_melpomene:0.0644896,Heliconius_erato_lativitta:0.274984)0.12419)0.0272171)0.0958765);", format=0)

#or t = Tree("file", format=0)

t.convert_to_ultrametric()

t.write(format=0, outfile="orthofinder_210624_ultra.nw")

#manually change to integers (~ x 10) and check in figtree, save as orthofinder_210624_ultra_mod.nw


```


```{r setup2}
#install.packages('devtools')
#devtools::install_github("palfalvi/badirater")
library(treeio)
library(badirater)
library(dypl)

```

```{r split_ortho}
#from BadirateR
split_orthogroups("input/Orthogroups.GeneCount_mod.tsv", max_count = 250, og_path = "badirate_orthogroups")


```

```{r get_branch_nr}
#from BadirateR
#have to use a specific version of perl
system("~/perl5/perlbrew/perls/perl-5.16.3/bin/perl")
bd_path = "/Applications/badirate-1.35/"

bd_branch_numbers(tree = "input/orthofinder_210624_ultra_mod.nw",
               og = "input/Orthogroups.GeneCount_mod.tsv",
               badirate_path = bd_path,
               plot = TRUE,
               tree_file = "branch_ids.tree")

#or use bash 
#get the branch names
#~/perl5/perlbrew/perls/perl-5.16.3/bin/perl /Applications/badirate-1.35/BadiRate.pl -treefile orthofinder_210624_ultra_mod.nw -sizefile Orthogroups.GeneCount_mod.tsv -print_id

```

```{r models}

branch_models = c("gr" = "GR",
                  "fr" = "FR",
                  "sp" = "10->8",
                  "spT" = "10->9",
                  "spV" = "10->9_10->8",
                  "spM" = "10->8_17->1",
                  "spVs" = "10->9:10->8",
                  "spMs" = "10->8:17->1")

```

```{r prepare}
#from BadirateR
#better to write the scripts manually, but good to run this to get setup table
setup_table <- prepare_badirate(og_path = "badirate_orthogroups/",
                                tree = "input/orthofinder_210624_ultra_mod.nw",
                                branch_models = branch_models,
                                rate_model = "BDI",
                                out_dir = "./raw_outputs",
                                script_dir = "./scripts",
                                replicates = 2,
                                ancestral = TRUE,
                                outlier = TRUE,
                                seed = 20180808,
                                start_value = 1,
                                pbs_q = "small",
                                badirate_path = bd_path,
                                create_scripts = "none")


setup_table

write.csv(setup_table, "./setup_table.csv")
```


```{r collect_result}
#from BadirateR
#does not work...
setup_table <- readr::read_csv("setup_table_no_fr.csv")

bd_collect(setup_table, out_dir = "results")


```

```{r model_selection}
#from BadirateR
#this does not work...
dir.create("./analysis")

best_models <- bd_model_select(setup_table = setup_table, 
                               results_dir = "./results")


readr::write_csv(best_models, "./analysis/best_models.csv")

best_models

```

```{bash}
#parse result 
#best model
#get likelihoods:
grep "Likelihood:" ../raw_outputs/gr/*.gr01.bd > gr01.likelihood.txt
#repeat for all models

#get all likelihoods in one file
paste results/gr01.likelihood.txt results/gr02.likelihood.txt | awk 'BEGIN{print "orthogroup gr01 gr02"}{print $1,$3,$6}' | sed -E 's/..\/raw_outputs\/gr\/|.tsv.gr01.bd\://g' > results/general_results.txt

paste results/sp01.likelihood.txt results/sp02.likelihood.txt | awk 'BEGIN{print "sp01 sp02"}{print $3, $6}' | paste results/general_results.txt - > results/general_results1.txt && mv results/general_results1.txt results/general_results.txt
paste results/spM01.likelihood.txt results/spM02.likelihood.txt | awk 'BEGIN{print "spM01 spM02"}{print $3, $6}' | paste results/general_results.txt - > results/general_results1.txt && mv results/general_results1.txt results/general_results.txt 
paste results/spT01.likelihood.txt results/spT02.likelihood.txt | awk 'BEGIN{print "spT01 spT02"}{print $3, $6}' | paste results/general_results.txt - > results/general_results1.txt && mv results/general_results1.txt results/general_results.txt 
paste results/spV01.likelihood.txt results/spV02.likelihood.txt | awk 'BEGIN{print "spV01 spV02"}{print $3, $6}' | paste results/general_results.txt - > results/general_results1.txt && mv results/general_results1.txt results/general_results.txt 

paste spMs01.likelihood.txt spMs02.likelihood.txt | awk 'BEGIN{print "spMs01 spMs02"}{print $3, $6}' | paste general_results.txt - > general_results1.txt && mv general_results1.txt general_results.txt 
results karin$ less general_results.txt 
paste spVs01.likelihood.txt spVs02.likelihood.txt | awk 'BEGIN{print "spVs01 spVs02"}{print $3, $6}' | paste general_results.txt - > general_results1.txt && mv general_results1.txt general_results.txt 

```


```{r best_repl}

#get data
res_likelihood <- read.table("results/general_results.txt", header = T)

#best replicate
res_likelihood$gr_best <- ifelse(res_likelihood$gr01>res_likelihood$gr02, res_likelihood$gr01, res_likelihood$gr02)
res_likelihood$sp_best <- ifelse(res_likelihood$sp01>res_likelihood$sp02, res_likelihood$sp01, res_likelihood$sp02)
res_likelihood$spM_best <- ifelse(res_likelihood$spM01>res_likelihood$spM02, res_likelihood$spM01, res_likelihood$spM02)
res_likelihood$spT_best <- ifelse(res_likelihood$spT01>res_likelihood$spT02, res_likelihood$spT01, res_likelihood$spT02)
res_likelihood$spV_best <- ifelse(res_likelihood$spV01>res_likelihood$spV02, res_likelihood$spV01, res_likelihood$spV02)
res_likelihood$spMs_best <- ifelse(res_likelihood$spMs01>res_likelihood$spMs02, res_likelihood$spMs01, res_likelihood$spMs02)
res_likelihood$spVs_best <- ifelse(res_likelihood$spVs01>res_likelihood$spVs02, res_likelihood$spVs01, res_likelihood$spVs02)



#list best replicate

sp_best_repl <- data.frame(res_likelihood$orthogroup)

sp_best_repl$best_orthogroup <- ifelse(res_likelihood$sp01>res_likelihood$sp02,
                      paste(res_likelihood$orthogroup,".tsv.sp01.bd",sep = ""),
                      paste(res_likelihood$orthogroup,".tsv.sp02.bd",sep = ""))

gr_best_repl <- data.frame(res_likelihood$orthogroup)

gr_best_repl$best_orthogroup <- ifelse(res_likelihood$gr01>res_likelihood$gr02,
                      paste(res_likelihood$orthogroup,".tsv.gr01.bd",sep = ""),
                      paste(res_likelihood$orthogroup,".tsv.gr02.bd",sep = ""))

spT_best_repl <- data.frame(res_likelihood$orthogroup)

spT_best_repl$best_orthogroup <- ifelse(res_likelihood$spT01>res_likelihood$spT02,
                      paste(res_likelihood$orthogroup,".tsv.spT01.bd",sep = ""),
                      paste(res_likelihood$orthogroup,".tsv.spT02.bd",sep = ""))

spVs_best_repl <- data.frame(res_likelihood$orthogroup)

spVs_best_repl$best_orthogroup <- ifelse(res_likelihood$spVs01>res_likelihood$spVs02,
                      paste(res_likelihood$orthogroup,".tsv.spVs01.bd",sep = ""),
                      paste(res_likelihood$orthogroup,".tsv.spVs02.bd",sep = ""))

spMs_best_repl <- data.frame(res_likelihood$orthogroup)

spMs_best_repl$best_orthogroup <- ifelse(res_likelihood$spMs01>res_likelihood$spMs02,
                      paste(res_likelihood$orthogroup,".tsv.spMs01.bd",sep = ""),
                      paste(res_likelihood$orthogroup,".tsv.spMs02.bd",sep = ""))

#best model
#have to account for parameters check setup table
# "","model","setup","path","tree_size","replicates","parameters"
# "1","gr","GR","./raw_outputs/gr",16,2,3
# "2","fr","FR","./raw_outputs/fr",16,2,48
# "3","sp","10->8","./raw_outputs/sp",16,2,6
# "4","spT","10->9","./raw_outputs/spT",16,2,6
# "5","spV","10->9_10->8","./raw_outputs/spV",16,2,9
# "6","spM","10->8_17->1","./raw_outputs/spM",16,2,9
#spVs 


#aikaike 
#2K-2logL
res_likelihood$gr_AIC <- ((2*3) - (2*res_likelihood$gr_best))
res_likelihood$sp_AIC <- ((2*6) - (2*res_likelihood$sp_best))
res_likelihood$spM_AIC <- ((2*6) - (2*res_likelihood$spM_best))
res_likelihood$spT_AIC <- ((2*9) - (2*res_likelihood$spT_best))
res_likelihood$spV_AIC <- ((2*9) - (2*res_likelihood$spV_best))
res_likelihood$spMs_AIC <- ((2*6) - (2*res_likelihood$spMs_best))
res_likelihood$spVs_AIC <- ((2*6) - (2*res_likelihood$spVs_best))



#Aikaike scores
#modelAIC - minAIC
for (i in 1:length(res_likelihood$orthogroup)){
  res_likelihood$sp_AIC_score[i] <- res_likelihood$sp_AIC[i]-min(res_likelihood$gr_AIC[i],res_likelihood$sp_AIC[i])
}
  
length(res_likelihood[res_likelihood$sp_AIC_score==0,22])


for (i in 1:length(res_likelihood$orthogroup)){
  res_likelihood$gr_AIC_score[i] <- res_likelihood$gr_AIC[i]-min(res_likelihood$gr_AIC[i],res_likelihood$sp_AIC[i])
}


for (i in 1:length(res_likelihood$orthogroup)){
  res_likelihood$spM_AIC_score[i] <- res_likelihood$spM_AIC[i]-min(res_likelihood$gr_AIC[i],res_likelihood$spM_AIC[i])
}
length(res_likelihood[res_likelihood$spM_AIC_score==0,1])


for (i in 1:length(res_likelihood$orthogroup)){
  res_likelihood$spT_AIC_score[i] <- res_likelihood$spT_AIC[i]-min(res_likelihood$gr_AIC[i],res_likelihood$spT_AIC[i])
}
length(res_likelihood[res_likelihood$spT_AIC_score==0,1])


for (i in 1:length(res_likelihood$orthogroup)){
  res_likelihood$spV_AIC_score[i] <- res_likelihood$spV_AIC[i]-min(res_likelihood$gr_AIC[i],res_likelihood$spV_AIC[i])
}
length(res_likelihood[res_likelihood$spV_AIC_score==0,1])

for (i in 1:length(res_likelihood$orthogroup)){
  res_likelihood$spVs_AIC_score[i] <- res_likelihood$spVs_AIC[i]-min(res_likelihood$gr_AIC[i],res_likelihood$spVs_AIC[i])
}
length(res_likelihood[res_likelihood$spVs_AIC_score==0,1])

for (i in 1:length(res_likelihood$orthogroup)){
  res_likelihood$spMs_AIC_score[i] <- res_likelihood$spMs_AIC[i]-min(res_likelihood$gr_AIC[i],res_likelihood$spMs_AIC[i])
}
length(res_likelihood[res_likelihood$spMs_AIC_score==0,1])


par(mfrow=c(2,3))
hist(res_likelihood$sp_AIC_score, breaks = 100)
hist(res_likelihood$spM_AIC_score, breaks = 100)
hist(res_likelihood$spT_AIC_score, breaks = 100)
hist(res_likelihood$spV_AIC_score, breaks = 100)
hist(res_likelihood$spVs_AIC_score, breaks = 100)
hist(res_likelihood$spMs_AIC_score, breaks = 100)


```


```{r write_OG}
#list of best replicate
write.table(file = "results/sp_best_likelihood.txt", sp_best_repl$best_orthogroup, row.names = F, quote = F)

write.table(file = "results/gr_best_likelihood.txt", gr_best_repl$best_orthogroup, row.names = F, quote = F)

write.table(file = "results/spT_best_likelihood.txt", spT_best_repl$best_orthogroup, row.names = F, quote = F)

write.table(file = "results/spMs_best_likelihood.txt", spMs_best_repl$best_orthogroup, row.names = F, quote = F)

write.table(file = "results/spVs_best_likelihood.txt", spVs_best_repl$best_orthogroup, row.names = F, quote = F)

#list of orthogroups with higher likelihood then the global model
write.table(file = "results/sp_vs_gr_OG_list.txt", res_likelihood[res_likelihood$sp_AIC_score==0,1])

write.table(file = "results/spMs_vs_gr_OG_list.txt", res_likelihood[res_likelihood$spMs_AIC_score==0,1])

write.table(file = "results/spT_vs_gr_OG_list.txt", res_likelihood[res_likelihood$spT_AIC_score==0,1])

write.table(file = "results/spVs_vs_gr_OG_list.txt", res_likelihood[res_likelihood$spVs_AIC_score==0,1])

```

